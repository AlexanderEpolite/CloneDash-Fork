# this workflow will build a .NET project
# for more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net
name: Build Release
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        os:
          - windows-latest
          - ubuntu-latest
          - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Create Directory.Build.props to suppress NU1605
        shell: bash
        run: |
          cat > Directory.Build.props <<'EOF'
          <Project>
            <PropertyGroup>
              <RestoreNoWarn>$(RestoreNoWarn);NU1605</RestoreNoWarn>
              <NoWarn>$(NoWarn);NU1605</NoWarn>
            </PropertyGroup>
          </Project>
          EOF

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore ./CloneDash.sln -p:RestoreNoWarn=NU1605

      - name: Build (Release)
        run: dotnet build ./CloneDash.sln --configuration Release --no-restore

      - name: Publish Windows single-file exe (framework-dependent)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          dotnet publish "./CloneDash" `
            -c Release `
            -f net8.0 `
            -r win-x64 `
            -p:SelfContained=false `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:EnableCompressionInSingleFile=true `
            -p:RestoreNoWarn=NU1605 `
            -o "./publish/win-x64-single"
          $exe = Get-ChildItem -Path "./publish/win-x64-single" -Filter *.exe | Select-Object -First 1
          if (-not $exe) { throw "No exe produced in ./publish/win-x64-single" }
          Copy-Item $exe.FullName "./CloneDash-Game-Windows-Portable.exe" -Force

      - name: Zip for Release (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $tempDir = "tempzip"
          Remove-Item -Recurse -Force $tempDir -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path $tempDir | Out-Null
          Copy-Item -Recurse -Force "./CloneDash/bin/Release/net8.0/*" $tempDir
          Copy-Item -Recurse -Force "./Nucleus.ModelEditor/bin/Release/net8.0/*" $tempDir
          Compress-Archive -Path "$tempDir\*" -DestinationPath "./CloneDash-Game-Windows.zip" -Force
          Remove-Item -Recurse -Force $tempDir

      - name: Publish Linux (framework-dependent) for AppImage
        if: matrix.os == 'ubuntu-latest'
        run: |
          dotnet publish ./CloneDash \
            -c Release \
            -f net8.0 \
            -p:SelfContained=false \
            -p:RestoreNoWarn=NU1605 \
            -o ./publish/linux

      - name: Build AppImage (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail
          APPDIR=AppDir
          rm -rf "$APPDIR"
          mkdir -p "$APPDIR/usr/bin"
          cp -r ./publish/linux/* "$APPDIR/usr/bin/"
          cat > "$APPDIR/AppRun" << 'EOF'
          #!/bin/sh
          set -e
          HERE="$(dirname "$(readlink -f "$0")")"
          MAIN_BIN="$HERE/usr/bin/Clone Dash"
          if [ ! -x "$MAIN_BIN" ]; then
            CANDIDATE="$(find "$HERE/usr/bin" -maxdepth 1 -type f -perm -111 | head -n1)"
            if [ -z "$CANDIDATE" ]; then
              echo "No executable found in AppImage usr/bin" >&2
              exit 1
            fi
            MAIN_BIN="$CANDIDATE"
          fi
          exec "$MAIN_BIN" "$@"
          EOF
          chmod +x "$APPDIR/AppRun"
          cat > "$APPDIR/CloneDash.desktop" << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=CloneDash
          Comment=CloneDash Game
          Exec=AppRun %F
          Icon=CloneDash
          Categories=Game;
          Terminal=false
          EOF
          base64 -d > "$APPDIR/CloneDash.png" << 'EOF'
          iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8Xw8AAvoB9B9l60wAAAAASUVORK5CYII=
          EOF
          curl -L -o appimagetool-x86_64.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          ./appimagetool-x86_64.AppImage --appimage-extract
          ARCH=x86_64 ./squashfs-root/AppRun "$APPDIR"
          mv CloneDash-*.AppImage ./CloneDash-Game-Linux.AppImage || mv AppDir-*.AppImage ./CloneDash-Game-Linux.AppImage

      - name: Zip for Release (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -e
          rm -rf tempzip
          mkdir -p tempzip
          cp -r "./CloneDash/bin/Release/net8.0/"* tempzip/
          cp -r "./Nucleus.ModelEditor/bin/Release/net8.0/"* tempzip/
          zip -r "./CloneDash-Game-Linux.zip" tempzip
          rm -rf tempzip

      - name: Zip for Release (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -e
          rm -rf tempzip
          mkdir -p tempzip
          cp -r "./CloneDash/bin/Release/net8.0/"* tempzip/
          cp -r "./Nucleus.ModelEditor/bin/Release/net8.0/"* tempzip/
          zip -r "./CloneDash-Game-macOS.zip" tempzip
          rm -rf tempzip

      - name: Upload artifact - Windows zip
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: CloneDash-Game-Windows
          path: ./CloneDash-Game-Windows.zip
          if-no-files-found: error

      - name: Upload artifact - Windows Portable exe
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: CloneDash-Game-Windows-Portable
          path: ./CloneDash-Game-Windows-Portable.exe
          if-no-files-found: error

      - name: Upload artifact - Linux zip
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: CloneDash-Game-Linux
          path: ./CloneDash-Game-Linux.zip
          if-no-files-found: error

      - name: Upload artifact - Linux AppImage
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: CloneDash-Game-Linux-AppImage
          path: ./CloneDash-Game-Linux.AppImage
          if-no-files-found: error

      - name: Upload artifact - macOS zip
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: CloneDash-Game-macOS
          path: ./CloneDash-Game-macOS.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./dist

      - name: Compute short SHA tag
        id: meta
        shell: bash
        run: |
          SHORT="${GITHUB_SHA::7}"
          echo "tag=$SHORT" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          fail_on_unmatched_files: true
          files: |
            dist/CloneDash-Game-Windows/CloneDash-Game-Windows.zip
            dist/CloneDash-Game-Windows-Portable/CloneDash-Game-Windows-Portable.exe
            dist/CloneDash-Game-Linux/CloneDash-Game-Linux.zip
            dist/CloneDash-Game-Linux-AppImage/CloneDash-Game-Linux.AppImage
            dist/CloneDash-Game-macOS/CloneDash-Game-macOS.zip